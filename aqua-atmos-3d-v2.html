<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AQUA-ATMOS â€” Module Sorbant</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#050a12; overflow:hidden; font-family:'Rajdhani',sans-serif; color:#cdd9e5; }
  canvas { display:block; }

  #header {
    position:fixed; top:0; left:0; right:0; z-index:10;
    padding:14px 24px;
    background:linear-gradient(to bottom, rgba(5,10,18,0.95), transparent);
    display:flex; justify-content:space-between; align-items:center;
  }
  #header h1 { font-size:1.5rem; font-weight:700; color:#00d4ff; letter-spacing:0.1em; }
  #header p  { font-size:0.72rem; color:#4a7f9a; font-family:'Share Tech Mono'; margin-top:2px; }
  #badge {
    font-family:'Share Tech Mono'; font-size:0.72rem; color:#00d4ff;
    border:1px solid rgba(0,212,255,0.3); padding:5px 12px; border-radius:4px;
    background:rgba(0,212,255,0.06);
  }

  #tabs {
    position:fixed; top:72px; left:50%; transform:translateX(-50%);
    display:flex; gap:6px; z-index:10;
    background:rgba(5,10,18,0.85); padding:8px 10px; border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);
  }
  .tab {
    padding:7px 14px; border-radius:5px; cursor:pointer;
    font-size:0.8rem; font-weight:600; letter-spacing:0.04em;
    border:1px solid transparent; transition:all 0.2s; color:#6a8aaa;
  }
  .tab:hover { color:#cdd9e5; border-color:rgba(255,255,255,0.1); }
  .tab.active { border-color:var(--c); color:var(--c); background:rgba(0,0,0,0.2); }
  .tab[data-m="sorbant"]     { --c:#2ecc71; }
  .tab[data-m="peltier"]     { --c:#9b59b6; }
  .tab[data-m="filtration"]  { --c:#1abc9c; }
  .tab[data-m="reservoir"]   { --c:#3498db; }
  .tab[data-m="electronique"]{ --c:#e74c3c; }
  .tab[data-m="solaire"]     { --c:#f39c12; }
  .tab[data-m="all"]         { --c:#00d4ff; }

  #infobox {
    position:fixed; bottom:72px; left:24px; width:270px;
    background:rgba(5,15,30,0.92); border:1px solid rgba(0,212,255,0.2);
    border-radius:8px; padding:16px;
  }
  #infobox h3 { font-size:0.95rem; font-weight:700; color:#00d4ff; margin-bottom:6px; }
  #infobox p  { font-size:0.79rem; color:#7a9ab2; line-height:1.6; }
  .spec { display:flex; justify-content:space-between; padding:3px 0;
    border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.76rem; }
  .sk { color:#4a7f9a; font-family:'Share Tech Mono'; }
  .sv { color:#00d4ff; font-weight:600; }

  #controls {
    position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
    display:flex; gap:8px;
  }
  .btn {
    background:rgba(5,15,30,0.85); border:1px solid rgba(255,255,255,0.1);
    color:#8ba8bf; padding:8px 16px; border-radius:5px; cursor:pointer;
    font-family:'Rajdhani'; font-size:0.82rem; font-weight:600; transition:all 0.2s;
  }
  .btn:hover { border-color:#00d4ff; color:#00d4ff; }
  .btn.on { border-color:#00d4ff; color:#00d4ff; background:rgba(0,212,255,0.08); }

  #hint {
    position:fixed; bottom:72px; right:24px;
    font-family:'Share Tech Mono'; font-size:0.67rem; color:#1e3a4a; line-height:1.9;
    text-align:right;
  }

  #module-tag {
    position:fixed; top:130px; left:50%; transform:translateX(-50%);
    font-family:'Share Tech Mono'; font-size:0.75rem; color:#2a5a3a;
    background:rgba(46,204,113,0.05); border:1px solid rgba(46,204,113,0.15);
    padding:4px 14px; border-radius:20px;
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="header">
  <div>
    <h1>AQUA-ATMOS</h1>
    <p>SystÃ¨me hybride de production d'eau atmosphÃ©rique â€” Vue 3D</p>
  </div>
  <div id="badge">PLBD 35 â€” ECC â€” Janvier 2026</div>
</div>

<div id="tabs">
  <div class="tab active" data-m="sorbant"      onclick="showModule('sorbant')">ðŸŸ¢ Sorbant</div>
  <div class="tab"        data-m="peltier"      onclick="showModule('peltier')">ðŸŸ£ Peltier</div>
  <div class="tab"        data-m="filtration"   onclick="showModule('filtration')">ðŸ©µ Filtration</div>
  <div class="tab"        data-m="reservoir"    onclick="showModule('reservoir')">ðŸ”µ RÃ©servoir</div>
  <div class="tab"        data-m="electronique" onclick="showModule('electronique')">ðŸ”´ Ã‰lectronique</div>
  <div class="tab"        data-m="solaire"      onclick="showModule('solaire')">ðŸŸ¡ Solaire</div>
  <div class="tab"        data-m="all"          onclick="showModule('all')">â¬œ Assemblage</div>
</div>

<div id="module-tag">MODULE SORBANT â€” CaClâ‚‚</div>

<div id="infobox">
  <h3 id="info-title">MODULE SORBANT</h3>
  <p id="info-desc">Tissu coton noir imprÃ©gnÃ© de CaClâ‚‚. Absorption nocturne de l'humiditÃ©. RÃ©gÃ©nÃ©ration solaire Ã  60-80Â°C.</p>
  <div id="info-specs" style="margin-top:10px">
    <div class="spec"><span class="sk">Surface</span><span class="sv">45 Ã— 35 cm</span></div>
    <div class="spec"><span class="sk">CaClâ‚‚</span><span class="sv">500 â€“ 800 g</span></div>
    <div class="spec"><span class="sk">Production</span><span class="sv">0.4 â€“ 0.5 L/j</span></div>
    <div class="spec"><span class="sk">TÂ° rÃ©gÃ©n.</span><span class="sv">60 â€“ 80 Â°C</span></div>
  </div>
</div>

<div id="controls">
  <button class="btn" onclick="resetView()">âŸ³ Reset vue</button>
  <button class="btn" id="btn-wire" onclick="toggleWire()">â¬š Filaire</button>
  <button class="btn" id="btn-rot"  onclick="toggleRot()">â†» Rotation auto</button>
  <button class="btn" id="btn-exp"  onclick="toggleExplode()">âŠž Vue Ã©clatÃ©e</button>
</div>

<div id="hint">
  ðŸ–± Clic gauche â†’ Rotation<br>
  ðŸ–± Scroll â†’ Zoom<br>
  ðŸ–± Clic droit â†’ DÃ©placer
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// =====================================================
// RENDERER + SCENE + CAMERA
// =====================================================
const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled = true;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050a12);
scene.fog = new THREE.Fog(0x050a12, 900, 2200);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 3000);
camera.position.set(250, 220, 480);
camera.lookAt(0, 80, 0);

// LIGHTS
scene.add(new THREE.AmbientLight(0x1a3a5c, 1.0));
const sun = new THREE.DirectionalLight(0xffffff, 1.3);
sun.position.set(300, 500, 300); sun.castShadow = true;
scene.add(sun);
const fill = new THREE.DirectionalLight(0x003355, 0.6);
fill.position.set(-300, 100, -200);
scene.add(fill);
const accent = new THREE.PointLight(0x00d4ff, 0.7, 700);
accent.position.set(0, 280, 180);
scene.add(accent);

// SOL + GRILLE
const sol = new THREE.Mesh(new THREE.PlaneGeometry(1400,1400),
  new THREE.MeshStandardMaterial({ color:0x080e16, roughness:0.98 }));
sol.rotation.x = -Math.PI/2; sol.position.y = -2; sol.receiveShadow = true;
scene.add(sol);
scene.add(new THREE.GridHelper(1000, 50, 0x0c1f2e, 0x081520));

// =====================================================
// CONTROLES SOURIS
// =====================================================
let drag=false, pan=false, prev={x:0,y:0};
let sph = {theta:0.55, phi:1.05, r:580};
let tgt = new THREE.Vector3(0, 80, 0);

canvas.addEventListener('mousedown', e => {
  if(e.button===0) drag=true;
  if(e.button===2) pan=true;
  prev={x:e.clientX,y:e.clientY};
});
window.addEventListener('mouseup', ()=>{ drag=false; pan=false; });
window.addEventListener('mousemove', e => {
  const dx=e.clientX-prev.x, dy=e.clientY-prev.y;
  if(drag){ sph.theta-=dx*0.005; sph.phi=Math.max(0.1,Math.min(Math.PI-0.1,sph.phi+dy*0.005)); }
  if(pan){
    const r=new THREE.Vector3().crossVectors(camera.getWorldDirection(new THREE.Vector3()),camera.up).normalize();
    tgt.addScaledVector(r,-dx*0.35); tgt.y+=dy*0.35;
  }
  prev={x:e.clientX,y:e.clientY};
});
canvas.addEventListener('wheel', e => sph.r=Math.max(120,Math.min(1600,sph.r+e.deltaY*0.5)));
canvas.addEventListener('contextmenu',e=>e.preventDefault());
window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

// =====================================================
// HELPERS
// =====================================================
function mkBox(w,h,d,color,opacity,px,py,pz,rx=0,ry=0,rz=0,metalness=0.1,roughness=0.75){
  const m=new THREE.MeshStandardMaterial({color,opacity,transparent:opacity<0.99,
    roughness,metalness,side:opacity<0.99?THREE.DoubleSide:THREE.FrontSide});
  const mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),m);
  mesh.position.set(px,py,pz); mesh.rotation.set(rx,ry,rz);
  mesh.castShadow=true; mesh.receiveShadow=true;
  scene.add(mesh); return mesh;
}
function mkCyl(r,h,color,opacity,px,py,pz,rx=0,metalness=0.2,roughness=0.6){
  const m=new THREE.MeshStandardMaterial({color,opacity,transparent:opacity<0.99,roughness,metalness});
  const mesh=new THREE.Mesh(new THREE.CylinderGeometry(r,r,h,32),m);
  mesh.position.set(px,py,pz); mesh.rotation.x=rx;
  mesh.castShadow=true; scene.add(mesh); return mesh;
}
function mkEdges(mesh,color=0x00d4ff,op=0.45){
  const e=new THREE.LineSegments(new THREE.EdgesGeometry(mesh.geometry),
    new THREE.LineBasicMaterial({color,opacity:op,transparent:true}));
  e.position.copy(mesh.position); e.rotation.copy(mesh.rotation); scene.add(e); return e;
}
function mkLabel(text,px,py,pz,color='#00d4ff'){
  const c=document.createElement('canvas'); c.width=320; c.height=72;
  const ctx=c.getContext('2d');
  ctx.fillStyle='rgba(2,12,28,0.88)';
  ctx.beginPath(); ctx.roundRect(3,3,314,66,9); ctx.fill();
  ctx.strokeStyle=color; ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.roundRect(3,3,314,66,9); ctx.stroke();
  ctx.fillStyle=color; ctx.font='bold 21px sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text,160,36);
  const tex=new THREE.CanvasTexture(c);
  const mesh=new THREE.Mesh(new THREE.PlaneGeometry(96,22),
    new THREE.MeshBasicMaterial({map:tex,transparent:true,depthTest:false}));
  mesh.position.set(px,py,pz); mesh.userData.label=true; scene.add(mesh); return mesh;
}

// =====================================================
// TOUS LES MODULES (objets stockÃ©s pour show/hide)
// =====================================================
const modules = {
  sorbant:[],
  peltier:[],
  filtration:[],
  reservoir:[],
  electronique:[],
  solaire:[]
};

// =====================================================
// MODULE SORBANT
// =====================================================
function buildSorbant(){
  const BW=150, BD=95, Z=160;
  const objs=[];

  // Coque extÃ©rieure (contour)
  const coqueEdges=mkEdges(mkBox(BW*2,100,BD*2,0x2ecc71,0.08,0,Z+50,0),0x2ecc71,0.4);
  objs.push(coqueEdges);

  // Nappe chauffante (bas)
  const nappe=mkBox(BW*2-10,5,BD*2-10,0xe74c3c,0.95,0,Z+5,0,0,0,0,0,0.85);
  objs.push(nappe);
  objs.push(mkLabel('Nappe chauffante 12V',0,Z-10,0,'#e74c3c'));

  // Grille inox
  const grille=mkBox(BW*2-10,3,BD*2-10,0xdddddd,1,0,Z+11,0,0,0,0,0.85,0.2);
  // Fils grille
  for(let i=-5;i<=5;i++){
    objs.push(mkBox(BW*2-12,1,1,0xbbbbbb,0.7,0,Z+13,i*18,0,0,0,0.7,0.3));
    objs.push(mkBox(1,1,BD*2-12,0xbbbbbb,0.7,i*26,Z+13,0,0,0,0,0.7,0.3));
  }
  objs.push(grille);

  // Tissu CaCl2
  const tissu=mkBox(BW*2-10,20,BD*2-10,0x27ae60,0.95,0,Z+23,0,0,0,0,0,0.97);
  objs.push(tissu);
  objs.push(mkLabel('Tissu CaClâ‚‚ sur coton noir',0,Z+38,0,'#2ecc71'));

  // Espace vapeur
  objs.push(mkBox(BW*2-10,32,BD*2-10,0x88ccff,0.07,0,Z+53,0));

  // Vitre inclinÃ©e
  const vitGeo=new THREE.BoxGeometry(BW*2,3,BD*2);
  const vitMat=new THREE.MeshStandardMaterial({color:0xaaddff,opacity:0.38,transparent:true,
    roughness:0.05,side:THREE.DoubleSide});
  const vitre=new THREE.Mesh(vitGeo,vitMat);
  vitre.position.set(0,Z+76,0); vitre.rotation.x=-0.175;
  vitre.castShadow=true; scene.add(vitre); objs.push(vitre);
  const ve=new THREE.LineSegments(new THREE.EdgesGeometry(vitGeo),
    new THREE.LineBasicMaterial({color:0x88ccff,opacity:0.7,transparent:true}));
  ve.position.copy(vitre.position); ve.rotation.copy(vitre.rotation);
  scene.add(ve); objs.push(ve);
  objs.push(mkLabel('Vitre plexiglas 3mm inclinÃ©e 10Â°',0,Z+92,0,'#88ccff'));

  // GouttiÃ¨re (cÃ´tÃ© avant bas vitre)
  const gout=mkBox(BW*2,6,10,0x2471a3,1,0,Z+66,BD-5,0,0,0,0.65,0.3);
  objs.push(gout);
  objs.push(mkLabel('GouttiÃ¨re â†’ tuyau guidÃ©',-BW-30,Z+66,BD-5,'#2471a3'));

  // Volets (5)
  for(let i=0;i<5;i++){
    objs.push(mkBox(BW*2-4,3,15,0x44445a,0.95,0,Z+7+i*13,-BD+12+i*18,0,0,0,0.3,0.7));
  }
  objs.push(mkLabel('Volets lamelles + servo',BW+40,Z+35,0,'#888899'));

  // Servo
  objs.push(mkBox(14,20,24,0x222233,1,BW-18,Z+12,0));
  objs.push(mkCyl(2,14,0x888888,1,BW-14,Z+22,0));

  // Ventilateur
  objs.push(mkBox(30,30,6,0x2a2a3a,0.9,0,Z+20,-BD+5));
  objs.push(mkCyl(13,6,0x111122,1,0,Z+20,-BD+5,Math.PI/2));
  objs.push(mkLabel('Ventilateur air',0,Z+20,-BD-20,'#555566'));

  // DS18B20
  const ds=mkCyl(2.5,10,0xe74c3c,1,-55,Z+64,0);
  objs.push(ds); objs.push(mkLabel('DS18B20',-55,Z+78,0,'#e74c3c'));

  // DHT22 intÃ©rieur
  objs.push(mkBox(10,14,6,0xf39c12,1,30,Z+64,0));
  objs.push(mkLabel('DHT22 int.',30,Z+78,0,'#f39c12'));

  // LDR
  const ldr=mkCyl(4,5,0xf1c40f,1,BW-15,Z+80,-25);
  objs.push(ldr);
  const lg=new THREE.PointLight(0xffee00,0.5,60);
  lg.position.set(BW-15,Z+84,-25); scene.add(lg); objs.push(lg);
  objs.push(mkLabel('LDR â˜€',BW-15,Z+94,-25,'#f1c40f'));

  // Label principal
  objs.push(mkLabel('ðŸŸ¢ MODULE SORBANT',0,Z+110,0,'#2ecc71'));

  return objs;
}

// =====================================================
// MODULE PELTIER
// =====================================================
function buildPeltier(){
  const BW=150, BD=95, Z=60;
  const objs=[];

  mkEdges(mkBox(BW*2,100,BD*2,0x9b59b6,0.06,0,Z+50,0),0x9b59b6,0.35);

  // 4 modules Peltier: 2 gauche, 2 droite
  function peltier(x,y,z){
    const side = x>0 ? 1 : -1;
    // Dissipateur extÃ©rieur
    const diss=mkBox(8,40,40,0xaaaaaa,1,x+side*14,y,z,0,0,0,0.9,0.2);
    for(let i=0;i<6;i++) mkBox(8,1,40,0xbbbbcc,0.8,x+side*14,y-18+i*7,z,0,0,0,0.9,0.2);
    // Corps TEC
    const tec=mkBox(20,40,40,0x9b59b6,1,x,y,z,0,0,0,0.3,0.5);
    // Face froide
    mkBox(4,40,40,0xaaddff,0.7,x-side*10,y,z,0,0,0,0,0.1);
    const gl=new THREE.PointLight(0x00aaff,0.5,80);
    gl.position.set(x-side*14,y,z); scene.add(gl);
    objs.push(diss,tec);
  }

  peltier(-BW+14, Z+75, -22);
  peltier(-BW+14, Z+75,  22);
  peltier( BW-14, Z+75, -22);
  peltier( BW-14, Z+75,  22);
  objs.push(mkLabel('TEC1-12706 Ã— 4',0,Z+110,0,'#9b59b6'));
  objs.push(mkLabel('Dissipateurs (extÃ©rieur)',BW+55,Z+75,0,'#888899'));

  // Ventilateur central
  objs.push(mkBox(40,40,6,0x2a2a3a,0.9,0,Z+55,0));
  objs.push(mkCyl(18,5,0x111122,1,0,Z+55,0,Math.PI/2));
  objs.push(mkLabel('Ventilateur 12V',0,Z+55,-40,'#555566'));

  // GouttiÃ¨re Peltier (condensation coule en bas)
  objs.push(mkBox(BW*2-4,5,10,0x2471a3,1,0,Z+5,BD-5,0,0,0,0.65,0.3));
  objs.push(mkLabel('GouttiÃ¨re Peltier â†’ tuyau',0,Z+5,BD+25,'#2471a3'));

  // Tuyau guidÃ©
  const tGeo=new THREE.CylinderGeometry(4,4,55,16);
  const tMat=new THREE.MeshStandardMaterial({color:0x2471a3,opacity:0.75,transparent:true});
  const tuyau=new THREE.Mesh(tGeo,tMat);
  tuyau.position.set(-BW+20,Z+28,BD-5); tuyau.rotation.x=Math.PI/6;
  scene.add(tuyau); objs.push(tuyau);

  objs.push(mkLabel('ðŸŸ£ MODULE PELTIER',0,Z-18,0,'#9b59b6'));
  return objs;
}

// =====================================================
// MODULE FILTRATION
// =====================================================
function buildFiltration(){
  const BW=150, BD=95, Z=10;
  const objs=[];

  // Corps filtre cylindrique
  const filt=mkCyl(14,55,0x1abc9c,0.95,-BW+26,Z+28,BD-18);
  objs.push(filt);

  // Couche charbon actif
  objs.push(mkCyl(10,22,0x222222,0.95,-BW+26,Z+33,BD-18));
  // Couche 5Âµm
  objs.push(mkCyl(10,18,0xeeeeee,0.95,-BW+26,Z+12,BD-18));

  // Couvercle
  objs.push(mkCyl(14,4,0x16a085,1,-BW+26,Z+57,BD-18));

  objs.push(mkLabel('Filtre 5Âµm + Charbon',-BW+26,Z+72,BD-18,'#1abc9c'));

  // TDS
  objs.push(mkBox(10,6,4,0xe74c3c,1,-BW+44,Z+30,BD-18));
  objs.push(mkLabel('TDS',-BW+56,Z+30,BD-18,'#e74c3c'));

  // DÃ©bitmÃ¨tre
  objs.push(mkBox(8,8,8,0xf39c12,1,-BW+60,Z+28,BD-15));
  objs.push(mkLabel('DÃ©bitmÃ¨tre',-BW+75,Z+28,BD-15,'#f39c12'));

  // Tuyau sortie filtre â†’ rÃ©servoir
  const tGeo=new THREE.CylinderGeometry(4,4,30,16);
  const tMat=new THREE.MeshStandardMaterial({color:0x2471a3,opacity:0.75,transparent:true});
  const t=new THREE.Mesh(tGeo,tMat);
  t.position.set(-BW+26,Z-7,BD-18); scene.add(t); objs.push(t);

  objs.push(mkLabel('ðŸ©µ FILTRATION',0,Z-25,0,'#1abc9c'));
  return objs;
}

// =====================================================
// MODULE RESERVOIR
// =====================================================
function buildReservoir(){
  const BW=150, BD=95, Z=-70;
  const objs=[];

  // RÃ©servoir
  const resa=mkBox(BW*2-14,70,BD*2-14,0x2980b9,0.5,0,Z+35,0,0,0,0,0,0.4);
  mkEdges(resa,0x3498db,0.6);
  objs.push(resa);

  // Eau intÃ©rieure
  objs.push(mkBox(BW*2-20,42,BD*2-20,0x1a5f8a,0.75,0,Z+21,0,0,0,0,0,0.15));

  // HC-SR04
  objs.push(mkBox(14,8,14,0xe74c3c,1,50,Z+68,0));
  objs.push(mkLabel('HC-SR04 (niveau)',50,Z+80,0,'#e74c3c'));

  // FenÃªtre niveau (gauche)
  objs.push(mkBox(3,55,28,0x88ccff,0.35,-BW+1,Z+35,0));
  objs.push(mkLabel('FenÃªtre niveau eau',-BW-40,Z+35,0,'#88ccff'));

  // Robinet
  objs.push(mkBox(18,18,16,0x2980b9,1,-BW+10,Z+20,55,0,0,0,0.7,0.3));
  objs.push(mkBox(6,8,6,0x2980b9,1,-BW+4,Z+27,55,0,0,0,0.7,0.3));
  const rout=mkCyl(4,22,0x2980b9,1,-BW+10,Z+16,66,0,0.7,0.3);
  rout.rotation.x=Math.PI/2; objs.push(rout);
  // Goutte eau
  objs.push(mkCyl(4,8,0x1a6090,0.8,-BW+10,Z+3,76));
  objs.push(mkLabel('Robinet sortie',-BW-40,Z+15,60,'#3498db'));

  objs.push(mkLabel('ðŸ”µ RÃ‰SERVOIR 5L',0,Z-18,0,'#3498db'));
  return objs;
}

// =====================================================
// MODULE ELECTRONIQUE
// =====================================================
function buildElectronique(){
  const BW=150, BD=95, Z=-130;
  const objs=[];

  // Batterie
  objs.push(mkBox(110,30,BD*2-14,0x2c3e50,1,-22,Z+15,0,0,0,0,0.1,0.8));
  objs.push(mkLabel('Batterie 12V 7Ah',-22,Z+32,0,'#7f8c8d'));

  // ESP32
  objs.push(mkBox(48,28,55,0x1a4a2a,1,82,Z+14,0,0,0,0,0.2,0.7));
  // PCB traces
  for(let i=0;i<4;i++) objs.push(mkBox(38,1,2,0x00aa44,1,82,Z+26,i*10-15,0,0,0,0.2,0.5));
  objs.push(mkLabel('ESP32 + Relais',82,Z+32,0,'#27ae60'));

  // MPPT
  objs.push(mkBox(28,20,28,0x1a3a1a,1,82,Z+10,35,0,0,0,0.2,0.7));
  objs.push(mkLabel('MPPT',82,Z+26,35,'#2ecc71'));

  // OLED (face latÃ©rale gauche)
  objs.push(mkBox(3,22,35,0x001122,1,-BW,Z+130,-20));
  objs.push(mkBox(2,18,30,0x00aacc,0.9,-BW-1,Z+130,-20));
  // Glow OLED
  const gl=new THREE.PointLight(0x00aaff,0.4,50);
  gl.position.set(-BW-2,Z+130,-20); scene.add(gl);
  objs.push(mkLabel('OLED 1.3"',-BW-40,Z+130,-20,'#00aacc'));

  // Boutons
  const b1=mkCyl(5,4,0xe74c3c,1,-BW,Z+115,10);
  b1.rotation.z=Math.PI/2; objs.push(b1);
  const b2=mkCyl(5,4,0x27ae60,1,-BW,Z+100,10);
  b2.rotation.z=Math.PI/2; objs.push(b2);
  objs.push(mkLabel('BTN ON/OFF + Auto',-BW-40,Z+107,10,'#888899'));

  // DHT22 extÃ©rieur
  objs.push(mkBox(4,20,25,0xf39c12,1,-BW,Z+145,-55));
  objs.push(mkLabel('DHT22 ext.',-BW-40,Z+145,-55,'#f39c12'));

  objs.push(mkLabel('ðŸ”´ ELECTRONIQUE',0,Z-18,0,'#e74c3c'));
  return objs;
}

// =====================================================
// MODULE SOLAIRE
// =====================================================
function buildSolaire(){
  const BW=150, Z=140;
  const objs=[];

  // Cadre panneau
  objs.push(mkBox(140,5,80,0x1a2a3a,1,BW+90,Z,0,0,0,0,0.1,0.6));
  // Cellules
  for(let i=0;i<5;i++) for(let j=0;j<3;j++){
    objs.push(mkBox(23,4,22,0x0d3a5c,1,BW+32+i*25,Z+2,j*24-24,0,0,0,0.3,0.4));
    objs.push(mkBox(21,4,20,0x1a4a7c,0.7,BW+32+i*25,Z+4,j*24-24,0,0,0,0.5,0.15));
  }
  // Glow solaire
  const sg=new THREE.PointLight(0xf39c12,0.6,250);
  sg.position.set(BW+90,Z+30,0); scene.add(sg); objs.push(sg);

  // CÃ¢ble (tube courbe)
  const curve=new THREE.CatmullRomCurve3([
    new THREE.Vector3(BW+22,Z,0),
    new THREE.Vector3(BW+10,Z-40,0),
    new THREE.Vector3(BW+5,-110,0),
    new THREE.Vector3(BW-2,-115,0),
  ]);
  const tGeo=new THREE.TubeGeometry(curve,20,2.5,8);
  const tMat=new THREE.MeshStandardMaterial({color:0xe67e22,roughness:0.8});
  const cable=new THREE.Mesh(tGeo,tMat);
  scene.add(cable); objs.push(cable);

  objs.push(mkLabel('Panneau 50W',BW+90,Z+22,0,'#f39c12'));
  objs.push(mkLabel('CÃ¢ble 2m',BW+40,Z-50,0,'#e67e22'));
  objs.push(mkLabel('ðŸŸ¡ PANNEAU SOLAIRE',0,Z+40,0,'#f39c12'));
  return objs;
}

// =====================================================
// CONSTRUIRE TOUS LES MODULES
// =====================================================
modules.sorbant      = buildSorbant();
modules.peltier      = buildPeltier();
modules.filtration   = buildFiltration();
modules.reservoir    = buildReservoir();
modules.electronique = buildElectronique();
modules.solaire      = buildSolaire();

// Afficher seulement le sorbant au dÃ©part
Object.keys(modules).forEach(k => {
  modules[k].forEach(o => { if(o.visible !== undefined) o.visible = (k === 'sorbant'); });
});

// =====================================================
// INFOS PAR MODULE
// =====================================================
const infos = {
  sorbant: { title:'MODULE SORBANT', tag:'MODULE SORBANT â€” CaClâ‚‚',
    desc:'Tissu coton noir imprÃ©gnÃ© de CaClâ‚‚. Absorption nocturne de l\'humiditÃ© atmosphÃ©rique. RÃ©gÃ©nÃ©ration solaire Ã  60-80Â°C avec nappe chauffante backup.',
    specs:[['Surface','45 Ã— 35 cm'],['CaClâ‚‚','500 â€“ 800 g'],['Production','0.4 â€“ 0.5 L/j'],['TÂ° rÃ©gÃ©n.','60 â€“ 80 Â°C']]},
  peltier: { title:'MODULE PELTIER Ã— 4', tag:'MODULE PELTIER â€” TEC1-12706',
    desc:'4 modules TEC1-12706 sur parois latÃ©rales. Face froide intÃ©rieure pour condensation de l\'air humide. Dissipateurs aluminium cÃ´tÃ© extÃ©rieur.',
    specs:[['Modules','4 Ã— TEC1-12706'],['Tension','12V DC'],['Production','0.3 â€“ 0.5 L/j'],['Puissance','4 Ã— 72W max']]},
  filtration: { title:'FILTRATION', tag:'FILTRATION â€” 5Âµm + Charbon',
    desc:'Filtre sÃ©diments 5Âµm puis charbon actif. L\'eau descend par tuyau guidÃ© depuis les gouttiÃ¨res. Capteur TDS vÃ©rifie la qualitÃ© en sortie.',
    specs:[['Ã‰tape 1','Filtre 5Âµm'],['Ã‰tape 2','Charbon actif'],['Capteur','TDS qualitÃ©'],['CoÃ»t','~50 MAD']]},
  reservoir: { title:'RÃ‰SERVOIR 5L', tag:'RÃ‰SERVOIR â€” 5 litres',
    desc:'PolypropylÃ¨ne alimentaire. FenÃªtre transparente latÃ©rale. Capteur HC-SR04 ultrason pour mesure automatique du niveau. Robinet laiton en sortie.',
    specs:[['Volume','5 litres'],['Capteur','HC-SR04'],['Sortie','Robinet laiton'],['FenÃªtre','Plexiglas']]},
  electronique: { title:'Ã‰LECTRONIQUE', tag:'Ã‰LECTRONIQUE â€” ESP32',
    desc:'ESP32 microcontrÃ´leur. Batterie 12V 7Ah. RÃ©gulateur MPPT. Ã‰cran OLED + 2 boutons sur face latÃ©rale. Capteur INA219 mesure de courant.',
    specs:[['MCU','ESP32'],['Batterie','12V 7Ah'],['RÃ©gulateur','MPPT'],['Interface','OLED 1.3"']]},
  solaire: { title:'PANNEAU SOLAIRE', tag:'PANNEAU SOLAIRE â€” 50W',
    desc:'Panneau 50W externe reliÃ© par cÃ¢ble 2m. Charge la batterie qui alimente tous les modules. SystÃ¨me 100% autonome, pas de rÃ©seau Ã©lectrique.',
    specs:[['Puissance','50W'],['CÃ¢ble','2 mÃ¨tres'],['Tension OC','18V'],['Autonomie','100% solaire']]},
  all: { title:'ASSEMBLAGE COMPLET', tag:'VUE D\'ENSEMBLE â€” AQUA-ATMOS',
    desc:'SystÃ¨me hybride complet. Sorbant CaClâ‚‚ + Peltier Ã— 4. Filtration intÃ©grÃ©e. ContrÃ´le ESP32 + batterie + solaire. Production 1.0-1.8 L/jour.',
    specs:[['Production','1.0 â€“ 1.8 L/j'],['Budget','< 2000 MAD'],['Autonomie','100% solaire'],['Eau','Potable OMS']]}
};

function showModule(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.m===name));
  document.getElementById('module-tag').textContent = infos[name]?.tag || '';
  Object.keys(modules).forEach(k=>{
    modules[k].forEach(o=>{
      if(o.visible !== undefined) o.visible = (name==='all' || name===k);
    });
  });
  const info = infos[name] || infos.sorbant;
  document.getElementById('info-title').textContent = info.title;
  document.getElementById('info-desc').textContent = info.desc;
  document.getElementById('info-specs').innerHTML = info.specs
    .map(s=>`<div class="spec"><span class="sk">${s[0]}</span><span class="sv">${s[1]}</span></div>`)
    .join('');
}

// =====================================================
// CONTROLES
// =====================================================
let wireOn=false, autoRot=false, exploded=false;

function resetView(){ sph={theta:0.55,phi:1.05,r:580}; tgt.set(0,80,0); }
function toggleWire(){
  wireOn=!wireOn;
  document.getElementById('btn-wire').classList.toggle('on',wireOn);
  scene.traverse(o=>{ if(o.isMesh&&!o.userData.label) o.material.wireframe=wireOn; });
}
function toggleRot(){
  autoRot=!autoRot;
  document.getElementById('btn-rot').classList.toggle('on',autoRot);
}
function toggleExplode(){
  exploded=!exploded;
  document.getElementById('btn-exp').classList.toggle('on',exploded);
  const offsets={
    sorbant:[0,60,0], peltier:[0,0,0], filtration:[-50,0,50],
    reservoir:[0,-50,0], electronique:[0,-100,0], solaire:[80,0,0]
  };
  Object.keys(modules).forEach(k=>{
    const off = exploded ? offsets[k] : [0,0,0];
    modules[k].forEach(o=>{
      if(o.position) o.position.x += off[0]-(!exploded?offsets[k][0]:0);
    });
  });
}

// =====================================================
// BOUCLE ANIMATION
// =====================================================
let t=0;
function animate(){
  requestAnimationFrame(animate);
  t+=0.016;
  if(autoRot) sph.theta+=0.004;
  const x=sph.r*Math.sin(sph.phi)*Math.sin(sph.theta);
  const y=sph.r*Math.cos(sph.phi)+tgt.y;
  const z=sph.r*Math.sin(sph.phi)*Math.cos(sph.theta);
  camera.position.set(tgt.x+x,y,tgt.z+z);
  camera.lookAt(tgt);
  accent.intensity=0.5+Math.sin(t*1.8)*0.2;
  scene.traverse(o=>{ if(o.userData.label) o.quaternion.copy(camera.quaternion); });
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
